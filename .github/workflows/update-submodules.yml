name: Update Submodules

on:
 repository_dispatch:
  types: [submodule_push]
 workflow_dispatch: # Keeps manual trigger option

jobs:
 update:
  runs-on: ubuntu-latest
  steps:
   - name: Verify webhook signature
     env:
      WEBHOOK_SECRET: ${{ secrets.WEBHOOK_SECRET }}
     run: |
      echo "${{ github.event.client_payload.payload }}" > payload.json
      echo "${{ github.event.client_payload.signature }}" > signature.txt
      echo "$WEBHOOK_SECRET" | openssl dgst -sha256 -hmac - -verify signature.txt payload.json || exit 1

   - uses: actions/checkout@v3
     with:
      fetch-depth: 0
      token: ${{ secrets.PAT }}
      submodules: recursive

   - name: Git config
     run: |
      git config user.name github-actions
      git config user.email github-actions@github.com

   - name: Update submodules
     run: |
      git submodule update --remote
      git diff --exit-code || {
        git add .
        git commit -m "Update submodules"
        git push
      }
